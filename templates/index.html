<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Single Page App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='json-collapsible-tree/css/simpleJson.css') }}">
    <style>
        /* Hide the default scrollbar */
        ::-webkit-scrollbar {
            width: 6px; /* Width of the scrollbar */
            height: 6px; /* Height of the scrollbar */
        }

        /* Track (background) of the scrollbar */
        ::-webkit-scrollbar-track {
            background: #f1f1f1; /* Color of the track */
        }

        /* Handle (thumb) of the scrollbar */
        ::-webkit-scrollbar-thumb {
            background: #888; /* Color of the thumb */
            border-radius: 3px; /* Rounded corners of the thumb */
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555; /* Color of the thumb on hover */
        }

    </style>
</head>
<body>
    <div class="container mt-5">
        <center><h3>Security Search App</h3></center>
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <a class="nav-link active" id="search-tab" data-toggle="tab" href="#search">Search</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " id="rules-tab" data-toggle="tab" href="#rules">Rules</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " id="crowdstrike-tab" data-toggle="tab" href="#crowdStrike">CrowdStrike</a>
            </li>
        </ul>
        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="search">
                <h5>Search</h5>
                <form id="searchForm">
                    <div id="searchInputs" class="d-flex flex-column gap-2">
                        <div class="form-group">
                            <!-- <input type="text" class="form-control" name="search_query" placeholder="Enter search query"> -->
                            <textarea class="form-control" name="search_query" placeholder="Enter search query" style="height: 120px;"></textarea>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="submit" id="searchBtn" class="btn btn-success mb-3">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
                            Search
                        </button>
                    </div>
                </form>
                <table id="searchResults" class="table" style="display: none;">
                    <thead>
                        <tr>
                            <th scope="col">IP Address</th>
                            <th scope="col">Reputation</th>
                            <th scope="col">Analysis Date</th>
                            <th scope="col">Threat Severity Level</th>
                        </tr>
                    </thead>
                    <tbody id="searchResultsBody">
                        <!-- Results will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="rules">
                <h5>Rules</h5>
                <form id="searchRuleForm">
                    <div id="searchRuleInputs" class="d-flex flex-column gap-2">
                        <div class="form-group d-flex gap-2">
                            <input type="text" class="form-control" name="search_author" placeholder="Enter author name">
                            <input type="text" class="form-control" name="search_creation_date" placeholder="Enter creation date mm/dd/yyyy" onfocus="this.type='date'">    
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="submit" id="searchRuleBtn" class="btn btn-success mb-3">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
                            Search
                        </button>
                    </div>
                </form>
                <!-- Content for Rules tab goes here -->
                <div id="rulesResult" class="w-100 border">
                    
                </div>
            </div>
            <div class="tab-pane fade" id="crowdStrike">
                <h5 class="text-dark">CrowdStrike</h5>
                <form id="searchFormCS">
                    <div id="searchInputsCS" class="d-flex flex-column gap-2">
                        <div class="form-group">
                            <!-- <input type="text" class="form-control" name="search_query" placeholder="Enter search query"> -->
                            <textarea class="form-control" name="search_query" placeholder="Enter search query" style="height: 120px;"></textarea>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="submit" id="searchBtnCS" class="btn btn-success mb-3">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
                            Search
                        </button>
                    </div>
                </form>
                <div class="w-100 overflow-scroll">
                    <table id="searchResultsCS" class="table" style="display: none;">
                        <thead>
                            <tr>
                                <th scope="col">Indicators</th>
                                <th scope="col">Domain Type</th>
                                <th scope="col">IP Address Type</th>
                                <th scope="col">Actors</th>
                                <th scope="col">Malicious Confidence</th>
                                <th scope="col">Published Date</th>
                                <th scope="col">Kill Chain</th>
                                <th scope="col">Targets</th>
                                <th scope="col">Threat Types</th>
                                <th scope="col">Vulnerabilities</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsBodyCS">
                            <!-- Results will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
         // Function to handle tab switching
         $('.nav-tabs a').on('click', function (e) {
            e.preventDefault()
            $(this).tab('show')

            // Check if the Rules tab is active
            // if ($(this).attr('id') === 'rules-tab') {
            //     // Make AJAX request to fetch rules data
            //     $.ajax({
            //         type: 'GET',
            //         url: '/rules',
            //         success: function(response) {
            //             // Clear previous results
            //             $('#rulesTableBody').empty();

            //             // Append new results to the table
            //             response.forEach(function(rule) {
            //                 $('#rulesTableBody').append(`
            //                     <tr>
            //                         <td>${rule.name}</td>
            //                         <td>${rule.creation_date}</td>
            //                         <td>${rule.last_modification_date}</td>
            //                     </tr>
            //                 `);
            //             });

            //             // Show the table with results
            //             $('#rulesTable').show();
            //         },
            //         error: function(xhr, status, error) {
            //             console.error('Error:', error);
            //         }
            //     });
            // }
        });

        // Function to handle form submission for search
        $('#searchForm').on('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            // Show spinner and disable button
            $('#searchBtn').prop('disabled', true);
            $('#searchBtn .spinner-border').show();

            // Serialize form data
            var formData = $(this).serialize();

            // Send AJAX POST request
            $.ajax({
                type: 'POST',
                url: '/search',
                data: formData,
                success: function(response) {
                    // Clear previous results
                    $('#searchResultsBody').empty();

                    // Append new results to the table
                    response.results.forEach(function(result) {
                        $('#searchResultsBody').append(`
                            <tr>
                                <td>${result.ip_address}</td>
                                <td>${result.reputation}</td>
                                <td>${result.analysis_date}</td>
                                <td>${result.threat_level}</td>
                            </tr>
                        `);
                    });

                    // Show the table with results
                    $('#searchResults').show();
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                },
                complete: function() {
                    // Hide spinner and enable button
                    $('#searchBtn').prop('disabled', false);
                    $('#searchBtn .spinner-border').hide();
                }
            });
        });


        $('#searchRuleForm').on('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            // Show spinner and disable button
            $('#searchRuleBtn').prop('disabled', true);
            $('#searchRuleBtn .spinner-border').show();

            // Serialize form data
            var formData = $(this).serialize();
            console.log(formData)

            // Send AJAX POST request
            $.ajax({
                type: 'POST',
                url: '/rules',
                data: formData,
                success: function(response) {

                    console.log("this is response", response )
                    // $('#rulesResult').text(JSON.stringify(response, null, 2));
                    $('#rulesResult').empty().simpleJson({jsonObject: response,collapsedText:"......"});

                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                },
                complete: function() {
                    // Hide spinner and enable button
                    $('#searchRuleBtn').prop('disabled', false);
                    $('#searchRuleBtn .spinner-border').hide();
                }
            });
        });

        
        // Function to handle form submission for search
        $('#searchFormCS').on('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            // Show spinner and disable button
            $('#searchBtnCS').prop('disabled', true);
            $('#searchBtnCS .spinner-border').show();

            // Serialize form data
            var formData = $(this).serialize();

            // Send AJAX POST request
            $.ajax({
                type: 'POST',
                url: '/crowdStrikeSearch',
                data: formData,
                success: function(response) {
                    // Clear previous results
                    $('#searchResultsBodyCS').empty();

                    console.log(response.results)
                    // Append new results to the table
                    response.results.forEach(function(result) {
                        $('#searchResultsBodyCS').append(`
                            <tr>
                                <td>${result.indicator}</td>
                                <td>${result.domain_types}</td>
                                <td>${result.ip_address_types}</td>
                                <td>${result.actors}</td>
                                <td>${result.malicious_confidence}</td>
                                <td>${result.published_date}</td>
                                <td>${result.kill_chains}</td>
                                <td>${result.targets}</td>
                                <td>${result.threat_types}</td>
                                <td>${result.vulnerabilities}</td>
                            </tr>
                        `);
                    });

                    // Show the table with results
                    $('#searchResultsCS').show();
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                },
                complete: function() {
                    // Hide spinner and enable button
                    $('#searchBtnCS').prop('disabled', false);
                    $('#searchBtnCS .spinner-border').hide();
                }
            });
        });

    </script>
    <script src="{{ url_for('static', filename='json-collapsible-tree/js/simpleJson.js') }}"></script>
</body>
</html>
